<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</title>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#0f172a;
  --sub:#64748b;
  --primary:#4f46e5;
  --border:#e5e7eb;
  --radius:18px;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,#eef2ff,#f8fafc);
  color:var(--text);
}

.container{
  max-width:900px;
  margin:0 auto;
  padding:20px 16px 160px;
}

/* ===== í—¤ë” ===== */
.header h1{
  margin:0;
  font-size:22px;
  font-weight:800;
}
.header .updated{
  margin-top:6px;
  font-size:13px;
  color:var(--sub);
}

/* ===== ì¹´ë“œ ===== */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  margin-top:16px;
}

.card h3{
  margin:0 0 14px;
  font-size:16px;
  font-weight:700;
}

/* ===== ê³µí†µ ì…ë ¥ ===== */
.select, .date-box{
  display:flex;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  font-size:14px;
}

.select select{
  border:none;
  outline:none;
  font-size:14px;
  width:100%;
  background:none;
}

.date-box{
  cursor:pointer;
}
.date-box span{
  color:var(--sub);
  font-size:14px;
}

/* ìˆ¨ê¹€ date input */
.date-box input{
  position:absolute;
  opacity:0;
  pointer-events:none;
}

/* ===== í•„í„° ===== */
.filter-stack{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ===== ì•ŒëŒ ===== */
.alarm-stack{
  display:flex;
  flex-direction:column;
  gap:10px;
}

button{
  margin-top:6px;
  padding:14px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:700;
  font-size:15px;
}

/* ===== ì˜ˆì•½ ë°ì´í„° ===== */
.court-card{
  margin-bottom:22px;
}
.court-title{
  font-weight:700;
}
.court-loc{
  font-size:13px;
  color:var(--sub);
  margin-bottom:6px;
}
.date-box-view{
  background:#f8fafc;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}
.date-title{
  font-weight:600;
  font-size:14px;
  margin-bottom:8px;
}
.slots{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.slot{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:13px;
  background:#fff;
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h1>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</h1>
    <div class="updated" id="updatedAt">ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘â€¦</div>
  </div>

  <!-- í•„í„° -->
  <div class="card">
    <h3>í•„í„°</h3>
    <div class="filter-stack">
      <div class="select">
        ğŸ˜ï¸
        <select id="filterGu">
          <option value="">êµ¬ ì „ì²´</option>
          <option>ì²˜ì¸êµ¬</option>
          <option>ê¸°í¥êµ¬</option>
          <option>ìˆ˜ì§€êµ¬</option>
        </select>
      </div>

      <div class="select">
        ğŸ¾
        <select id="filterCourt">
          <option value="">ì½”íŠ¸ ì „ì²´</option>
        </select>
      </div>

      <label class="date-box" onclick="filterDate.click()">
        ğŸ“… <span id="filterDateLabel">ë‚ ì§œ ì„ íƒ</span>
        <input type="date" id="filterDate">
      </label>
    </div>
  </div>

  <!-- ì•ŒëŒ -->
  <div class="card">
    <h3>ğŸ”” ì•ŒëŒ ë“±ë¡(ë‚˜ì—ê²Œ ë³´ë‚¸ ë©”ì‹œì§€ë¡œ ì „ì†¡ë˜ì–´ ì•ŒëŒì´ ìš¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤)</h3>
    <div class="alarm-stack">
      <div class="select">
        ğŸ¾
        <select id="alarmCourt">
          <option value="">ì½”íŠ¸ ì„ íƒ</option>
        </select>
      </div>

      <label class="date-box" onclick="alarmDate.click()">
        ğŸ“… <span id="alarmDateLabel">ë‚ ì§œ ì„ íƒ</span>
        <input type="date" id="alarmDate">
      </label>

      <button id="alarmBtn">ì•ŒëŒ ë“±ë¡</button>
    </div>

    <div id="alarmList" style="margin-top:12px;font-size:13px;color:var(--sub)">
      ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- ë°ì´í„° -->
  <div class="card">
    <h3>ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©</h3>
    <div id="courts">
      â³ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦
    </div>
  </div>

</div>

<script>
const VAPID_PUBLIC_KEY = "BLLOhRZIO4FbSxSapToATz0L5QGkn_0UGBdVrwsp-IeEBfKd_vFyeDXiVsZ8AGJ2Dbv52zDMzQ-LU2qEVng9M7I";

let DATA = {};
let COURT_GROUPS = {};

async function enablePushIfNeeded() {
  // ì´ë¯¸ ê¶Œí•œ ìˆìœ¼ë©´ ë‹¤ì‹œ ì•ˆ ë¬¼ì–´ë´„
  if (Notification.permission === "granted") {
    return;
  }

  if (!("serviceWorker" in navigator)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  const permission = await Notification.requestPermission();
  if (permission !== "granted") {
    alert("ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    throw new Error("notification denied");
  }

  // Service Worker ë“±ë¡
  const reg = await navigator.serviceWorker.register("/sw.js");

  // Push êµ¬ë…
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
  });

  // ì„œë²„ì— ì €ì¥
  await fetch("/push/subscribe", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(sub)
  });
}

function urlBase64ToUint8Array(base64) {
  const padding = "=".repeat((4 - base64.length % 4) % 4);
  const b64 = (base64 + padding).replace(/-/g, "+").replace(/_/g, "/");
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}

function getCourtGroup(title){
  return title
    .replace(/\[.*?\]/g, "")   // [ìœ ë£Œ] ì œê±°
    .split("í…Œë‹ˆìŠ¤ì¥")[0]      // 'í…Œë‹ˆìŠ¤ì¥' ì•ê¹Œì§€ë§Œ ì‚¬ìš©
    .trim();
}

function getWeekday(yyyymmdd){
  const d=new Date(
    yyyymmdd.slice(0,4),
    yyyymmdd.slice(4,6)-1,
    yyyymmdd.slice(6,8)
  );
  return ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
}

let retryTimer = null;
let retryCount = 0;

async function loadData() {
  try {
    const res = await fetch("/data", {
      credentials: "same-origin"
    });

    const contentType = res.headers.get("content-type") || "";
    if (!contentType.includes("application/json")) {
      throw new Error("Not JSON response");
    }

    const data = await res.json();

    DATA = data;

    renderUpdatedTime(data.updated_at);
    buildCourtGroups();
    renderCourts();
    loadAlarms();

  } catch (e) {
    console.error("[loadData error]", e);
    document.getElementById("courts").innerHTML =
      "â³ ì„œë²„ì—ì„œ ì˜ˆì•½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
  }
}



function renderUpdatedTime(updatedAt) {
  if (!updatedAt) {
    document.getElementById("updatedTime").innerText =
      "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ : ì •ë³´ ì—†ìŒ";
    return;
  }

  const d = new Date(updatedAt);

  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");

  document.getElementById("updatedAt").innerText =
    `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ : ${hh}:${mm}`;
}



function buildCourtGroups(){
  COURT_GROUPS={};
  Object.values(DATA.facilities).forEach(f=>{
    const g=getCourtGroup(f.title);
    COURT_GROUPS[g]=true;
  });

  filterCourt.innerHTML='<option value="">ì½”íŠ¸ ì „ì²´</option>';
  alarmCourt.innerHTML='<option value="">ì½”íŠ¸ ì„ íƒ</option>';

  Object.keys(COURT_GROUPS)
  .sort((a, b) => a.localeCompare(b, "ko"))
  .forEach(g => {
    filterCourt.innerHTML += `<option>${g}</option>`;
    alarmCourt.innerHTML += `<option>${g}</option>`;
  });

}

filterDate.onchange=()=>{
  filterDateLabel.textContent = filterDate.value;
  renderCourts();
};
alarmDate.onchange=()=>{
  alarmDateLabel.textContent = alarmDate.value;
};

function makeReserveLink(resveId){
  const base =
    "https://publicsports.yongin.go.kr/publicsports/sports/selectFcltyRceptResveViewU.do";
  return `${base}?key=4236&resveId=${resveId}&pageUnit=8&pageIndex=1&checkSearchMonthNow=false`;
}



function renderCourts(){
  courts.innerHTML="";
  const gu=filterGu.value;
  const group=filterCourt.value;
  const date=filterDate.value.replaceAll("-","");

  for(const id in DATA.facilities){
    const fac=DATA.facilities[id];
    const g=getCourtGroup(fac.title);

    if(gu && !fac.location?.includes(gu)) continue;
    if(group && g!==group) continue;

    const days=DATA.availability[id];
    if(!days) continue;

    let has=false;
    let html=`<div class="court-card">
      <div class="court-title">${fac.title}</div>
      <div class="court-loc">${fac.location||""}</div>`;

    for(const d in days){
      if(date && d!==date) continue;
      if(!days[d].length) continue;
      has=true;
      html+=`<div class="date-box-view">
        <div class="date-title">
          ${d.slice(4,6)}.${d.slice(6,8)} (${getWeekday(d)})
        </div>
        <div class="slots">`;
      days[d].forEach(s=>{
        html+=`
          <a class="slot"
          href="${makeReserveLink(id)}"
          target="_blank">
          ${s.timeContent}
          </a>`;
      });
      html+=`</div></div>`;
    }

    html+=`</div>`;
    if(has) courts.innerHTML+=html;
  }

  if(!courts.innerHTML) courts.textContent="ì¡°ê±´ì— ë§ëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.";
}

async function loadAlarms(){
  const res = await fetch("/alarm/list",{ credentials: "same-origin" });
  const list = await res.json();

  if (!list.length) {
    alarmList.textContent = "ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  const grouped = {};
  list.forEach(a => {
    if (!grouped[a.court_group]) grouped[a.court_group] = [];
    grouped[a.court_group].push(a.date);
  });

  let html = "";
  Object.keys(grouped).sort().forEach(group => {
    grouped[group].forEach(date => {
      html += `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <span>${group} / ${date}</span>
          <button onclick="deleteAlarm('${group}','${date}')" style="background:none;color:red;border:none">ì‚­ì œ</button>
        </div>
      `;
    });
  });

  alarmList.innerHTML = html;
}

async function deleteAlarm(group, date){
  await fetch("/alarm/delete", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      court_group: group,
      date: date
    })
  });
  loadAlarms();
}


alarmBtn.onclick = async () => {

  await enablePushIfNeeded().catch((e)=>{
    console.error("[enablePushIfNeeded error]", e);
    alert("ì•Œë¦¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  });

  if (!alarmCourt.value || !alarmDate.value) {
    alert("ì½”íŠ¸ì™€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  const res = await fetch("/alarm/add", {
    method: "POST",
    credentials: "same-origin",   // ğŸ”¥ ì¤‘ìš”
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      court_group: alarmCourt.value,
      date: alarmDate.value
    })
  });

  if (res.status === 409) {
  alert("ì´ë¯¸ ë“±ë¡ëœ ì•ŒëŒì…ë‹ˆë‹¤.");
  return;
  }

  const data = await res.json();
  if (data.status === "ok") {
    loadAlarms();
    alert("ì•ŒëŒ ë“±ë¡ ì™„ë£Œ");
  }
  
  // ì•ŒëŒ ë“±ë¡ ì„±ê³µ í›„
  const subscriptionId = localStorage.getItem("subscription_id");

  await fetch("/push/test", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      subscription_id: subscriptionId
    })
  });

  alert("ì•ŒëŒ ë“±ë¡ ì™„ë£Œ! 20ì´ˆ í›„ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ì´ ìš¸ë¦½ë‹ˆë‹¤ ğŸ””");

  loadAlarms();
};
async function init() {
  await loadMe().catch(()=>{});
  await loadData();
}

function isDesktop() {
  return !/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
}

if (isDesktop()) {
  flatpickr("#filterDate", {
    dateFormat: "Y-m-d",
    onChange: function(selectedDates, dateStr) {
      filterDateLabel.textContent = dateStr;
      renderCourts();
    }
  });

  flatpickr("#alarmDate", {
    dateFormat: "Y-m-d",
    onChange: function(selectedDates, dateStr) {
      alarmDateLabel.textContent = dateStr;
    }
  });
}

filterGu.onchange=renderCourts;
filterCourt.onchange=renderCourts;
init();
</script>
</body>
</html>
