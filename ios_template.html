<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</title>

<style>
:root{
  --bg:#f5f7fb;
  --card:#ffffff;
  --text:#111827;
  --sub:#6b7280;
  --primary:#5b6dff;
  --border:#e5e7eb;
  --radius:16px;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,#eef2ff,#f9fafb);
  color:var(--text);
}

.container{
  max-width:900px;
  margin:0 auto;
  padding:20px 16px 140px;
}

.header h1{
  margin:0;
  font-size:22px;
  font-weight:800;
}
.header .sub{
  font-size:13px;
  color:var(--sub);
  margin-top:4px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  margin-top:14px;
}

.card h3{
  margin:0 0 10px;
  font-size:16px;
}

select,input,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:14px;
}

button{
  background:var(--primary);
  color:white;
  font-weight:700;
  border:none;
}

/* í•„í„° */
.filter-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.date-input{
  position:relative;
}
.date-input::before{
  content:"ğŸ“…";
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
}
.date-input input{
  padding-left:36px;
}

/* ì•ŒëŒ */
.alarm-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.alarm-grid button{
  grid-column:1 / -1;
}

.alarm-list{
  margin-top:10px;
  font-size:13px;
}
.alarm-item{
  padding:8px 10px;
  border-radius:10px;
  background:#f9fafb;
  border:1px solid var(--border);
  margin-top:6px;
}

/* ì˜ˆì•½ ë°ì´í„° */
.court-card{
  margin-bottom:20px;
}
.court-title{
  font-weight:700;
}
.court-loc{
  font-size:13px;
  color:var(--sub);
  margin-bottom:6px;
}
.date-box{
  background:#f9fafb;
  border-radius:12px;
  padding:10px;
  margin-top:8px;
}
.date-title{
  font-weight:600;
  font-size:14px;
  margin-bottom:6px;
}
.slots{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.slot{
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:13px;
  background:white;
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h1>ğŸ¾ ìš©ì¸ í…Œë‹ˆìŠ¤ ì˜ˆì•½</h1>
    <div class="sub" id="updatedAt">ì—…ë°ì´íŠ¸ í™•ì¸ ì¤‘â€¦</div>
  </div>

  <!-- í•„í„° -->
  <div class="card">
    <h3>í•„í„°</h3>
    <div class="filter-grid">
      <select id="filterGu">
        <option value="">êµ¬ ì „ì²´</option>
        <option>ì²˜ì¸êµ¬</option>
        <option>ê¸°í¥êµ¬</option>
        <option>ìˆ˜ì§€êµ¬</option>
      </select>

      <select id="filterCourt">
        <option value="">ì½”íŠ¸ ì „ì²´</option>
      </select>

      <div class="date-input">
        <input type="date" id="filterDate">
      </div>
    </div>
  </div>

  <!-- ì•ŒëŒ -->
  <div class="card">
    <h3>ğŸ”” ì•ŒëŒ ë“±ë¡</h3>
    <div class="alarm-grid">
      <select id="alarmCourt">
        <option value="">ì½”íŠ¸ ì„ íƒ</option>
      </select>
      <div class="date-input">
        <input type="date" id="alarmDate">
      </div>
      <button id="alarmBtn">ì•ŒëŒ ë“±ë¡</button>
    </div>

    <div class="alarm-list" id="alarmList">
      ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- ë°ì´í„° -->
  <div class="card">
    <h3>ì˜ˆì•½ ê°€ëŠ¥ í˜„í™©</h3>
    <div id="courts">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  </div>

</div>

<script>
let DATA = {};
let COURT_GROUPS = {};

function getCourtGroup(title){
  return title.replace(/\[.*?\]/g,"")
              .replace(/[0-9]/g,"")
              .replace(/ì¥ì• ì¸.*$/,"")
              .trim();
}

function getWeekday(yyyymmdd){
  const d=new Date(
    yyyymmdd.slice(0,4),
    yyyymmdd.slice(4,6)-1,
    yyyymmdd.slice(6,8)
  );
  return ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
}

async function loadData(){
  const res = await fetch("/data");
  DATA = await res.json();
  renderUpdated();
  buildCourtGroups();
  renderCourts();
  loadAlarms();
}

function renderUpdated(){
  updatedAt.textContent = DATA.updated_at
    ? "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: "+DATA.updated_at
    : "ì—…ë°ì´íŠ¸ ì¤€ë¹„ ì¤‘â€¦";
}

function buildCourtGroups(){
  COURT_GROUPS={};
  Object.values(DATA.facilities).forEach(f=>{
    const g=getCourtGroup(f.title);
    COURT_GROUPS[g]=true;
  });

  filterCourt.innerHTML='<option value="">ì½”íŠ¸ ì „ì²´</option>';
  alarmCourt.innerHTML='<option value="">ì½”íŠ¸ ì„ íƒ</option>';

  Object.keys(COURT_GROUPS).forEach(g=>{
    filterCourt.innerHTML+=`<option>${g}</option>`;
    alarmCourt.innerHTML+=`<option>${g}</option>`;
  });
}

function renderCourts(){
  courts.innerHTML="";
  const gu=filterGu.value;
  const group=filterCourt.value;
  const date=filterDate.value.replaceAll("-","");

  for(const id in DATA.facilities){
    const fac=DATA.facilities[id];
    const g=getCourtGroup(fac.title);

    if(gu && !fac.location?.includes(gu)) continue;
    if(group && g!==group) continue;

    const days=DATA.availability[id];
    if(!days) continue;

    let has=false;
    let html=`<div class="court-card">
      <div class="court-title">${fac.title}</div>
      <div class="court-loc">${fac.location||""}</div>`;

    for(const d in days){
      if(date && d!==date) continue;
      if(!days[d].length) continue;
      has=true;
      html+=`<div class="date-box">
        <div class="date-title">
          ${d.slice(4,6)}.${d.slice(6,8)} (${getWeekday(d)})
        </div>
        <div class="slots">`;
      days[d].forEach(s=>{
        html+=`<div class="slot">${s.timeContent}</div>`;
      });
      html+=`</div></div>`;
    }

    html+=`</div>`;
    if(has) courts.innerHTML+=html;
  }

  if(!courts.innerHTML) courts.textContent="ì¡°ê±´ì— ë§ëŠ” ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.";
}

async function loadAlarms(){
  const res=await fetch("/alarm/list");
  const list=await res.json();
  alarmList.innerHTML=list.length
    ? list.map(a=>`<div class="alarm-item">${a.court_group} / ${a.date}</div>`).join("")
    : "ë“±ë¡ëœ ì•ŒëŒì´ ì—†ìŠµë‹ˆë‹¤.";
}

alarmBtn.onclick=async()=>{
  if(!alarmCourt.value||!alarmDate.value){
    alert("ì½”íŠ¸ì™€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”");
    return;
  }
  await fetch("/alarm/add",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      court_group:alarmCourt.value,
      date:alarmDate.value
    })
  });
  loadAlarms();
};

filterGu.onchange=renderCourts;
filterCourt.onchange=renderCourts;
filterDate.onchange=renderCourts;

loadData();
</script>
</body>
</html>
