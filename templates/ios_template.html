<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>용인 테니스 예약 현황</title>

<style>
/* ================================
   COLOR THEME — Toss / NPay Style
================================ */
:root {
    --bg: #f7f8fa;
    --card: #ffffff;
    --text: #1a1a1c; 
    --sub: #6e6e73;
    --light: #a9a9ac;
    --accent: #0064ff;   /* Toss Blue */
    --radius: 18px;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
    :root {
        --bg: #000000;
        --card: #1b1b1d;
        --text: #f2f2f7;
        --sub: #a1a1aa;
        --light: #77777c;
        --accent: #4da3ff;
    }
}

body {
    background: var(--bg);
    color: var(--text);
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro", "SF Pro Text";
}

/* ================================
   NAVIGATION BAR
================================ */
.navbar {
    position: sticky;
    top: 0;
    background: var(--bg);
    padding: 16px;
    font-size: 20px;
    font-weight: 700;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    text-align: center;
}

/* ================================
   UPDATE TIME + ICON
================================ */
.update-row {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
    margin-bottom: 10px;
    color: var(--sub);
}

.update-icon {
    width: 14px;
    height: 14px;
    border: 2px solid var(--sub);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ================================
   FILTERS
================================ */
.segment {
    display: flex;
    gap: 8px;
    margin: 14px;
}
.segment button {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--light);
    background: var(--card);
    font-size: 14px;
    font-weight: 600;
    color: var(--sub);
    transition: 0.2s;
}
.segment button.active {
    background: var(--accent);
    color: white;
}

.filter-block {
    margin: 12px 14px;
}

.filter-block select,
#open-calendar {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid var(--light);
    background: var(--card);
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
}

/* ================================
   COURT CARD
================================ */
.court-card {
    background: var(--card);
    margin: 16px;
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}

.court-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
}

.court-location {
    font-size: 14px;
    color: var(--sub);
    margin-bottom: 14px;
}

.date-section {
    margin-bottom: 12px;
    background: rgba(0,0,0,0.04);
    padding: 12px;
    border-radius: 14px;
}

.date-header {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 8px;
}

.time-slot {
    background: var(--card);
    padding: 7px 12px;
    display: inline-block;
    margin: 4px;
    border-radius: 10px;
    font-size: 13px;
    border: 1px solid rgba(0,0,0,0.12);
}

/* ================================
   BOTTOM SHEET CALENDAR (iOS Style)
================================ */
.calendar-sheet {
    position: fixed;
    bottom: -440px;
    left: 0;
    right: 0;
    background: var(--card);
    border-radius: 24px 24px 0 0;
    padding: 20px 20px 30px 20px;
    box-shadow: 0 -6px 30px rgba(0,0,0,0.3);
    transition: 0.35s ease;
    z-index: 9999;
}
.calendar-sheet.show {
    bottom: 0;
}

.calendar-handle {
    width: 44px;
    height: 5px;
    background: rgba(120,120,120,0.28);
    border-radius: 3px;
    margin: 0 auto 16px auto;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}
.month-btn {
    font-size: 20px;
    padding: 4px 12px;
    cursor: pointer;
    color: var(--sub);
}
.calendar-title {
    font-size: 18px;
    font-weight: 700;
}

.weekdays {
    display: grid;
    grid-template-columns: repeat(7,1fr);
    text-align: center;
    font-size: 13px;
    color: var(--sub);
    margin-bottom: 6px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7,1fr);
    gap: 6px;
}

.cal-day {
    padding: 10px 0;
    font-size: 14px;
    text-align: center;
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    cursor: pointer;
    transition: 0.2s;
}
.cal-day:hover {
    background: var(--accent);
    color: white;
}
.cal-day.selected {
    background: var(--accent);
    color: white;
    font-weight: 700;
}

.calendar-close {
    margin-top: 18px;
    width: 100%;
    padding: 12px;
    background: var(--accent);
    color: white;
    font-weight: 700;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
}

</style>
</head>



<body>

<div class="navbar">용인 테니스 예약 현황</div>

<div class="update-row">
    <div class="update-icon"></div>
    <div id="updated-time">업데이트 시간 계산 중...</div>
</div>

<!-- 구 필터 -->
<div class="segment" id="filter-gu">
    <button data-gu="all" class="active">전체</button>
    <button data-gu="처인구">처인구</button>
    <button data-gu="기흥구">기흥구</button>
    <button data-gu="수지구">수지구</button>
</div>

<!-- 날짜 필터: Bottom Sheet -->
<div class="filter-block">
    <button id="open-calendar">날짜 선택하기</button>
</div>

<!-- 테니스장 그룹 필터 -->
<div class="filter-block">
    <select id="filter-court">
        <option value="all">전체 테니스장</option>
    </select>
</div>

<div id="content"></div>




<!-- ===========================
      BOTTOM SHEET CALENDAR
============================ -->
<div id="calendar-sheet" class="calendar-sheet">
    <div class="calendar-handle"></div>

    <div class="calendar-header">
        <div id="prev-month" class="month-btn">◀</div>
        <div id="month-title" class="calendar-title">2월 2025</div>
        <div id="next-month" class="month-btn">▶</div>
    </div>

    <div class="weekdays">
        <div>일</div><div>월</div><div>화</div>
        <div>수</div><div>목</div><div>금</div><div>토</div>
    </div>

    <div id="calendar-grid" class="calendar-grid"></div>

    <div id="close-calendar" class="calendar-close">닫기</div>
</div>





<script>
/* ================================
   상대적 업데이트 시간
================================ */
function timeAgo(ts) {
    const now = new Date();
    const past = new Date(ts);
    const diff = (now - past) / 1000;

    if (diff < 60) return "방금 전 업데이트됨";
    if (diff < 3600) return `${Math.floor(diff/60)}분 전 업데이트됨`;
    if (diff < 86400) return `${Math.floor(diff/3600)}시간 전 업데이트됨`;
    return `${Math.floor(diff/86400)}일 전 업데이트됨`;
}



/* ================================
   DATA LOAD
================================ */
let FACILITIES = {};
let AVAIL = {};
let ridToGroup = {};
let selectedDate = null;

async function loadData() {
    const res = await fetch("/data");
    const data = await res.json();

    FACILITIES = data.facilities;
    AVAIL = data.availability;

    document.getElementById("updated-time").textContent =
        data.updated_at ? timeAgo(data.updated_at) : "업데이트 정보 없음";

    buildCourtFilter();
    render();
}



/* ================================
   테니스장 그룹 필터 (남사=월 통합)
================================ */
function getGroupName(title) {
    title = title.replace(/\[.*?\]/g, "");  
    title = title.replace(/_[0-9]+월/g, ""); 
    const m = title.match(/(.+?)테니스장/);
    return m ? m[1].trim() : title.trim();
}

function buildCourtFilter() {
    let groups = new Set();

    for (let rid in FACILITIES) {
        const group = getGroupName(FACILITIES[rid].title);
        ridToGroup[rid] = group;
        groups.add(group);
    }

    const sel = document.getElementById("filter-court");

    Array.from(groups)
        .sort()
        .forEach(g => {
            const opt = document.createElement("option");
            opt.value = g;
            opt.textContent = g;
            sel.appendChild(opt);
        });
}



/* ================================
   CALENDAR (Bottom Sheet)
================================ */
let current = new Date();

function renderCalendar() {
    const year = current.getFullYear();
    const month = current.getMonth();

    document.getElementById("month-title").textContent = `${month+1}월 ${year}`;

    const first = new Date(year, month, 1).getDay();
    const last = new Date(year, month+1, 0).getDate();

    const grid = document.getElementById("calendar-grid");
    grid.innerHTML = "";

    for (let i=0;i<first;i++) grid.innerHTML += "<div></div>";

    for (let d=1; d<=last; d++) {
        const key =
            `${year}${String(month+1).padStart(2,'0')}${String(d).padStart(2,'0')}`;

        grid.innerHTML += `
            <div class="cal-day ${selectedDate===key?'selected':''}"
                 data-date="${key}">${d}</div>
        `;
    }

    document.querySelectorAll(".cal-day").forEach(day => {
        day.onclick = () => {
            selectedDate = day.dataset.date;
            hideCalendar();
            render();
        };
    });
}

document.getElementById("prev-month").onclick = () => {
    current.setMonth(current.getMonth()-1);
    renderCalendar();
};
document.getElementById("next-month").onclick = () => {
    current.setMonth(current.getMonth()+1);
    renderCalendar();
};

function showCalendar() {
    document.getElementById("calendar-sheet").classList.add("show");
    renderCalendar();
}
function hideCalendar() {
    document.getElementById("calendar-sheet").classList.remove("show");
}

document.getElementById("open-calendar").onclick = showCalendar;
document.getElementById("close-calendar").onclick = hideCalendar;



/* ================================
   날짜 표시 변환
================================ */
function formatKoreanDate(key) {
    const y = +key.substring(0,4);
    const m = +key.substring(4,6);
    const d = +key.substring(6,8);
    const dt = new Date(y, m-1, d);
    const w = ["일","월","화","수","목","금","토"][dt.getDay()];
    return `${m}월 ${d}일 (${w})`;
}



/* ================================
   RENDER — (잔여시간 없으면 COURT 숨김)
================================ */
function render() {
    const gu = document.querySelector("#filter-gu .active").dataset.gu;
    const courtGroup = document.getElementById("filter-court").value;

    let html = "";

    for (let rid in FACILITIES) {

        if (courtGroup !== "all" && ridToGroup[rid] !== courtGroup) continue;

        const loc = FACILITIES[rid].location || "";
        if (gu !== "all" && !loc.includes(gu)) continue;

        const days = AVAIL[rid] || {};

        let filteredDays = Object.keys(days);
        if (selectedDate) filteredDays = filteredDays.filter(d => d === selectedDate);

        // -------------------------------
        // ⭐ 중요한 부분: 잔여 시간이 하나도 없으면 숨김
        // -------------------------------
        const hasAnySlot = filteredDays.some(date => days[date].length > 0);
        if (!hasAnySlot) continue;



        html += `
        <div class="court-card">
            <div class="court-title">${FACILITIES[rid].title}</div>
            <div class="court-location">${FACILITIES[rid].location}</div>
        `;

        filteredDays.forEach(dk => {
            html += `
            <div class="date-section">
                <div class="date-header">${formatKoreanDate(dk)}</div>
            `;

            days[dk].forEach(t => {
                html += `<div class="time-slot">${t.timeContent}</div>`;
            });

            html += `</div>`;
        });

        html += `</div>`;
    }

    document.getElementById("content").innerHTML = html;
}



/* ================================
   FILTER EVENTS
================================ */
document.querySelectorAll("#filter-gu button").forEach(btn =>
    btn.addEventListener("click", () => {
        [...btn.parentElement.children].forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        render();
    })
);

document.getElementById("filter-court").addEventListener("change", render);


/* EXEC */
loadData();

</script>

</body>
</html>
