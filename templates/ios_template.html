<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>용인 테니스 예약 현황</title>

<style>
    :root {
        --bg: #f5f5f7;
        --card: #ffffff;
        --text: #1d1d1f;
        --blue: #007aff;
        --gray: #8e8e93;
        --radius: 18px;
    }

    @media (prefers-color-scheme: dark) {
    :root {
        --bg: #000000;
        --card: #2c2c2e; /* 기존 #1c1c1e보다 더 밝아서 구분 쉬움 */
        --text: #ffffff;
        --gray: #d1d1d6;
    }

    /* 날짜 박스가 안 보이는 문제 해결 */
    .date-section {
        background: #3a3a3c !important; /* 다크모드에서 확실히 보이게 */
    }

    /* 날짜 텍스트 강조 */
    .date-header {
        color: #ffffff !important;
    }

    /* time-slot 대비 강화 */
    .time-slot {
        background: #2c2c2e !important;
        border: 1px solid #4d4d4d !important;
        color: #ffffff !important;
    }

    /* 카드 윤곽을 더 명확하게 */
    .court-card {
        background: #2c2c2e !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6) !important;
    }

    /* 필터 버튼 색상도 조정 */
    .segment button {
        background: #2c2c2e;
        border: 1px solid #4d4d4d;
        color: #ffffff;
    }

    .segment button.active {
        background: #0A84FF !important; /* iOS 다크모드 공식 블루톤 */
        color: #ffffff;
    }

    .filter-block select {
        background: #2c2c2e;
        color: #ffffff;
        border: 1px solid #4d4d4d;
    }
    }
</style>
</head>

<body>

<div class="navbar">용인 테니스 예약 현황</div>

<!-- 구 필터 -->
<div class="segment" id="filter-gu">
    <button data-gu="all" class="active">전체</button>
    <button data-gu="처인구">처인구</button>
    <button data-gu="기흥구">기흥구</button>
    <button data-gu="수지구">수지구</button>
</div>

<!-- 날짜 필터 -->
<div class="segment" id="filter-date">
    <button data-date="tomorrow" class="active">내일</button>
    <button data-date="thisweek">이번주</button>
    <button data-date="thismonth">이번달</button>
    <button data-date="nextmonth">다음달</button>
</div>

<!-- 테니스장 필터 -->
<div class="filter-block">
    <select id="filter-court">
        <option value="all">전체 테니스장</option>
    </select>
</div>

<div id="content"></div>

<!-- -------------------- JS -------------------- -->
<script>
let FACILITIES = {};
let AVAIL = {};

async function loadData() {
    const res = await fetch("/data");
    const data = await res.json();

    FACILITIES = data.facilities;
    AVAIL = data.availability;

    const courtSelect = document.getElementById("filter-court");
    for (let rid in FACILITIES) {
        const opt = document.createElement("option");
        opt.value = rid;
        opt.textContent = FACILITIES[rid].title;
        courtSelect.appendChild(opt);
    }

    render();
}

function setActive(el) {
    const parent = el.parentElement;
    [...parent.children].forEach(btn => btn.classList.remove("active"));
    el.classList.add("active");
}

function filterByDate(days, filterType) {
    let result = {};
    const now = new Date();
    const tomorrow = new Date(now.getTime() + 86400000);
    const format = d => d.toISOString().slice(0,10).replace(/-/g,"");

    if (filterType === "tomorrow") {
        const key = format(tomorrow);
        if (days[key]) result[key] = days[key];
    }
    else if (filterType === "thisweek") {
        const end = new Date(now);
        end.setDate(now.getDate() + (7 - now.getDay()));
        for (let d = new Date(tomorrow); d <= end; d.setDate(d.getDate()+1)) {
            const key = format(d);
            if (days[key]) result[key] = days[key];
        }
    }
    else if (filterType === "thismonth") {
        const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
        for (let d = new Date(tomorrow); d <= end; d.setDate(d.getDate()+1)) {
            const key = format(d);
            if (days[key]) result[key] = days[key];
        }
    }
    else if (filterType === "nextmonth") {
        const start = new Date(now.getFullYear(), now.getMonth()+1, 1);
        const end = new Date(now.getFullYear(), now.getMonth()+2, 0);
        for (let d = start; d <= end; d.setDate(d.getDate()+1)) {
            const key = format(d);
            if (days[key]) result[key] = days[key];
        }
    }

    return result;
}

function render() {
    const guFilter = document.querySelector("#filter-gu .active").dataset.gu;
    const dateFilter = document.querySelector("#filter-date .active").dataset.date;
    const courtFilter = document.getElementById("filter-court").value;

    let html = "";

    for (let rid in FACILITIES) {
        if (courtFilter !== "all" && rid !== courtFilter) continue;

        const loc = FACILITIES[rid].location || "";
        if (guFilter !== "all" && !loc.includes(guFilter)) continue;

        let days = AVAIL[rid] || {};
        let filtered = filterByDate(days, dateFilter);
        if (Object.keys(filtered).length === 0) continue;

        html += `
        <div class="court-card">
            <div class="court-title">${FACILITIES[rid].title}</div>
            <div class="court-location">${FACILITIES[rid].location}</div>
        `;

        for (let dateKey in filtered) {
            html += `
            <div class="date-section">
                <div class="date-header">${dateKey}</div>
            `;
            filtered[dateKey].forEach(t => {
                html += `<div class="time-slot">${t.timeContent}</div>`;
            });
            html += `</div>`;
        }

        html += `</div>`;
    }

    document.getElementById("content").innerHTML = html;
}

document.querySelectorAll("#filter-gu button").forEach(btn =>
    btn.addEventListener("click", () => { setActive(btn); render(); })
);

document.querySelectorAll("#filter-date button").forEach(btn =>
    btn.addEventListener("click", () => { setActive(btn); render(); })
);

document.getElementById("filter-court").addEventListener("change", render);

loadData();
</script>

</body>
</html>
